## MQ 解决分布式事务

![](./img/transaction.bmp)

假设现在有订单服务和商品服务。订单服务需要下单，下单需要修改订单数据库；商品服务在下单后需要减少库存，库存数据库需要修改。需要注意的是，订单修改和商品修改两个操作是同属一个事务的，两者彼此成功，如果有其中任何一个没有成功，那么该事务将失败。下面看看如果处理该分布式事务案例。

这里可以采用消息中间件的方式来解决这个问题。首先是订单服务，订单服务需要在自己本地开启一个服务，完成订单操作，该操作流程如下：

* 1、添加订单、写入数据库
* 2、写消息表
* 3、给消息队列发送下单消息

订单服务操作结束后，消息队列中也有了一条订单消息，这时应该通知商品服务。

商品服务从消息队列中消费该消息，然后再本地开启一个事务，该事务操作流程如下：

* 1、接收下单信息
* 2、减少库存
* 3、写消息表
* 4、向消息队列发送扣除商品库存消息

消息队列获取到该消息后，将通知订单服务商品服务事务处理成功，这时订单服务便可以删除下单消息，只是将该下单记录添加到历史记录中。否则订单服务会开启一个定时器任务，不断扫描当前是否有活跃的下单记录，如果有下单记录，那么说明在超时时间内商品服务那边出错了，这时就又需要向消息队列发送下单服务，直到商品服务完成。